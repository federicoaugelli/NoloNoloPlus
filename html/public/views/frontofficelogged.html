<!doctype html>
<html lang="it">
  <head>
      <title>Frontoffice logged</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      
      <!-- Bootstrap CDN -->
      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet">
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
      <script src="//code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
      <link rel="shortcut icon" href="#">

      <!-- vue.js CDN
      <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14"></script>
      -->

      <!-- vue.js -->
      <script type="text/javascript" src="/js/vue.min.js"></script>
      <link rel="stylesheet" type="text/css" href="/css/frontoffice.css">
      <link rel="stylesheet" type="text/css" href="/css/login.css">
      <script type="text/javascript" src="/js/frontoffice.js"></script>


</head>

<body style="background-color: #031336;">
  <div id="app">

  <!-- NAVBAR -->
    <nav class="navbar navbar-dark navbar-expand-md bg-primary sticky-top py-4">
      <div style="margin-right: 10px; margin-left: 10px;" class="container-fluid">
        <a class="navbar-brand ml-auto" id="titleUser">NOLO NOLO</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarsExample04" aria-controls="navbarsExample04" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <form class="d-flex w-50 bottom-0 my-auto">
          <input class="form-control me-2" type="search" placeholder="Cerca" aria-label="inserisci la tua parola chiave di ricerca" v-model="searchQuery">
        </form>
        <div class="nav-item navbar-nav mr-auto dropstart">
          <a role="button" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" v-model="user = '<%= username %>'">Ciao <%= username %></a>
          <ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="dropdownMenuButton1">
            <li><a class="dropdown-item" data-bs-toggle="modal" data-bs-target="#clientModal">il Mio Account</a></li>
            <li><a class="dropdown-item" data-bs-toggle="modal" data-bs-target="#noleggiModal">I Miei Ordini</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="/frontendlogout" aria-label="Esci dal frotoffice">Esci</a></li>
          </ul>                 
        </div>
      </div>
    </nav>


<!-- modal cliente -->
  <div class="modal fade" id="clientModal" tabindex="-1" aria-labelledby="modalClient" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Il Mio Account</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
        </div>
        <div class="modal-footer">
        </div>
      </div>
    </div>
  </div>


<!-- modal noleggi -->
  <div class="modal fade" id="noleggiModal" tabindex="-1" aria-labelledby="modalNoleggi" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">I Miei Ordini</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div v-for="item in userItems" :key="item.usernameCliente" v-if="item.usernameCliente == user">
            <h5 class="">{{ item.titoloNoleggiato }}</h5>
            <div>dal {{ item.inzioNoleggio }} al {{ item.fineNoleggio }}</div>
            <div>prezzo: {{ item.prezzoTotale }}€</div>
            <div v-if="item.stato == 'futuro'">
              <button class="btn btn-primary">Modifica noleggio</button>
              <button class="btn btn-danger">Cancella noleggio</button>
            </div>
            <div v-else-if="item.stato == 'terminato'">
              <button class="btn btn-primary">Visualizza Fatture</button>
            </div>
            <div v-else>
              <button class="btn btn-success" disabled>In Corso</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>


    <div class="btn-group filterBar">
      <button v-if="searchQuery != ''" class="btn btn-danger" type="button" v-on:click="searchQuery = ''">Elimina filtro</button>
      <button class="btn btn-light active" :class="{ active: searchQuery == 'Playstation 5' }" type="button" v-on:click="searchQuery = 'Playstation 5'">ps5</button>
      <button class="btn btn-light" type="button" v-on:click="searchQuery = 'Playstation 4'">ps4</button>
      <button class="btn btn-light" type="button" v-on:click="searchQuery = 'Xbox One'">Xbox One</button>
      <button class="btn btn-light" type="button" v-on:click="searchQuery = 'Xbox Serie X/S'">Xbox X/S</button>
      <button class="btn btn-light" type="button" v-on:click="searchQuery = 'Nintendo'">Nintendo</button>
      <button class="btn btn-light" type="button" v-on:click="searchQuery = 'Pc'">Pc</button>
      <button class="btn btn-light" type="button" v-on:click="searchQuery = 'Nuovo'">Nuovi</button>
      <button class="btn btn-light" type="button" v-on:click="searchQuery = 'true'">Disponibili</button>
    </div>

  <!-- TABELLA FINALE -->
  <div class="album py-5">
    <div class="container">
      <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-3">
        
        <div class="col" v-for="item in resultQuery" :key="item.game">
          <!-- implementare card 'Nessun elemento' -->       
          <div class="card shadow-sm gameCard" style="text-align: center;">
            <div class="pegi">PEGI {{ item.etaMinima }}</div>
            <img v-if="item.platform == 'Playstation 4' || item.platform == 'Playstation 5'" class="platform-logo playstation" src="/img/playstation-brands.svg" alt="Card image1">
            <img v-else-if="item.platform == 'Xbox One'" class="platform-logo xbox" src="/img/xbox-brands.svg" alt="Card image1">
            <img v-else-if="item.platform == 'Pc'" class="platform-logo pc" src="/img/laptop-solid.svg" alt="Card image1">
            <div v-else class="platform-logo nintendo">Nintendo</div>
            <img class="card-img-top" src="/img/prova1.png" alt="Card image1">
            <div class="card-body">
              <h4 class="card-title" style="color: white;">{{ item.game }}</h4>
              <!--
              <a class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#card-modal">Noleggia</a>-->
              <a data-bs-toggle="modal" data-bs-target="#card-modal" class="rentbtn" v-on:click="popoModal(item)">
                <span></span>
                <span></span>
                <span></span>
                <span></span>
                Noleggia
              </a>
              <h6 style="color: white; margin-top: 10px;">{{ item.prezzo }}€ al giorno</h6>
            </div>
            <div class="card-footer">
              <small class="text-muted" style="position: absolute; right: 0; margin-right: 10px;">{{ item.annoUscita }}</small>
              <small class="text-muted">in {{ item.condizioni }} condizioni</small>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

    <!-- modal finale -->
   <div class="modal fade" id="card-modal" tabindex="-1" aria-labelledby="card-modalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-fullscreen-sm-down modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">{{ modalItem.game }} per {{ modalItem.platform }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" v-on:click="ipoteticalPrice = 0"></button>
        </div>
        <div class="modal-body">
          <div class="card-body">
            <h5>Il gioco è uscito nel {{ modalItem.annoUscita }}, è {{ modalItem.stato }} e in {{ modalItem.condizioni }} condizioni.</h6>
            <h6>Età minima: {{ modalItem.etaMinima }}</h6>
            <h6>Peso: {{ modalItem.peso }}</h6>
            <h6>Numero giocatori: {{ modalItem.numGiocatori }}</h6>
            <div style="margin-top: 40px; margin-bottom: 40px;">
              <h4>Quando vorresti noleggiarlo?</h4>
              <label for="startRent">Da:</label>
              <input type="date" id="startRent" name="startRent" v-model="startDate">
              <label for="finishRent">A:</label>
              <input type="date" id="finishRent" name="finishRent" v-model="endDate">
            </div>
            <h5>I tuoi punti fedeltà: user.punti</h5>
          </div>
        </div>
        <div class="modal-footer">
          <p v-if="ipoteticalPrice != 0 || ipoteticalPrice != ''" class="me-auto">costo: {{ ipoteticalPrice }}€</p>
          <button v-if="modalItem.disponibile" type="button" class="btn btn-primary" class="me-auto" v-on:click="calculateDate()">ipotesi</button>
          <button v-if="modalItem.disponibile" type="button" class="btn btn-primary" v-on:click="postLease()">Noleggia</button>
          <button v-else type="button" class="btn btn-primary" disabled>Non Disponibile</button>
        </div>
      </div>
    </div>
  </div>

 </div>

  <script type="text/javascript">
      
    new Vue({
      el: "#app",
      data () {
        return {
          searchQuery: '',
          items: '',
          user: '',
          userItems: '',
          modalItem: '',
          startDate: '',
          endDate: '',
          ipoteticalPrice: '',
          showModal: false
        }
      },

      mounted () {
        axios
          .get('/db/getGames')
          .then(response => (this.items = response.data.result));

        axios
          .get('/db/getUserItems')
          .then(gg => (this.userItems = gg.data.result));
      },

      computed: {
        resultQuery(){
          if(this.searchQuery !== "" && this.searchQuery !== "Nuovo" && this.searchQuery !== "Xbox One" && this.searchQuery !== "Xbox Serie X/S"  && this.searchQuery !== "Playstation 5" && this.searchQuery !== "Pc" && this.searchQuery !== "Playstation 4" && this.searchQuery !== "Nintendo" && this.searchQuery != "true"){
            return this.items.filter((gg)=>{
              return this.searchQuery.toLowerCase().split(' ').every(v => gg.game.toLowerCase().includes(v))
            })
          }
          else if (this.searchQuery == "Nuovo"){
            return this.items.filter((gg)=>{
              return this.searchQuery.toLowerCase().split(' ').every(v => gg.stato.toLowerCase().includes(v))
            })
          }
          else if (this.searchQuery == "Playstation 5"){
            return this.items.filter((gg)=>{
              return this.searchQuery.toLowerCase().split(' ').every(v => gg.platform.toLowerCase().includes(v))
            })
          }
          else if (this.searchQuery == "Playstation 4"){
            return this.items.filter((gg)=>{
              return this.searchQuery.toLowerCase().split(' ').every(v => gg.platform.toLowerCase().includes(v))
            })
          }
          else if (this.searchQuery == "Nintendo"){
            return this.items.filter((gg)=>{
              return this.searchQuery.toLowerCase().split(' ').every(v => gg.platform.toLowerCase().includes(v))
            })
          }
          else if (this.searchQuery == "Pc"){
            return this.items.filter((gg)=>{
              return this.searchQuery.toLowerCase().split(' ').every(v => gg.platform.toLowerCase().includes(v))
            })
          }
          else if (this.searchQuery == "Playstation 5"){
            return this.items.filter((gg)=>{
              return this.searchQuery.toLowerCase().split(' ').every(v => gg.platform.toLowerCase().includes(v))
            })
          }
          else if (this.searchQuery == "Xbox One"){
            return this.items.filter((gg)=>{
              return this.searchQuery.toLowerCase().split(' ').every(v => gg.platform.toLowerCase().includes(v))
            })
          }
          else if (this.searchQuery == "Xbox Serie X/S"){
            return this.items.filter((gg)=>{
              return this.searchQuery.toLowerCase().split(' ').every(v => gg.platform.toLowerCase().includes(v))
            })
          }
          else if (this.searchQuery == "true"){
            return this.items.filter((gg)=>{
              return this.searchQuery.toLowerCase().split(' ').every(v => gg.disponibile.toLowerCase().includes(v))
            })
          }
          else{
            return this.items;
          }
        },
/*
        calculateDate(){
          this.ipoteticalPrice = parseFloat(this.modalItem.prezzo) * (this.datediff(this.parseDate(this.startDate), this.parseDate(this.endDate)))
          return this.ipoteticalPrice
        }
*/
      },
      methods: {
        getUserItems(){
          console.log(this.userItems);
        },

        popoModal(item){
          this.modalItem = item;
        },

        parseDate(date){
          var mdy = date.split('-');
          return new Date(mdy[0], mdy[1], mdy[2]);
        },

        datediff(first, second) {
          return Math.round((second-first)/(1000*60*60*24));
        },

        calculateDate(){
          console.log(Math.floor(10000000 + Math.random() * 90000000));
          let yourDate = new Date().toISOString().split('T')[0];
          console.log(yourDate);
          console.log(this.startDate);
          console.log(yourDate.split('-'));
          console.log(this.parseDate(yourDate));
          if(this.datediff(this.parseDate(this.startDate), this.parseDate(this.endDate)) > 0 && this.datediff(this.parseDate(this.startDate), this.parseDate(yourDate)) >= 0){
            this.ipoteticalPrice = parseFloat(this.modalItem.prezzo) * (this.datediff(this.parseDate(this.startDate), this.parseDate(this.endDate)))
          }
          else{
            this.ipoteticalPrice = ''
          }
        },
/*
        postLease(item){
          const Lease = {
            "usernameCliente": this.user,
            "titoloNoleggiato": this.,
          }
          if(item != '') {
            axios
              .post('/db/createLease', item)
            //triggera un toast
          }
          //else triggera un toast
        }
        */
      },
    })

/*
  Implementare il modal con il prezzo moltiplicato per i giorni (non loggati)
  implementare i filtri per i loggati
  implementare le altre cose per i loggati
*/

  </script>
</div>
</body>
</html>